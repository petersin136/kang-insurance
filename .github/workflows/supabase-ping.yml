name: Supabase Keep-Alive Ping

# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” Supabase í”„ë¡œì íŠ¸ê°€ 7ì¼ í›„ ìë™ ì¼ì‹œì¤‘ì§€ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´
# ì£¼ê¸°ì ìœ¼ë¡œ ê°„ë‹¨í•œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

on:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ë§¤ì£¼ ì›”ìš”ì¼, ëª©ìš”ì¼ ì˜¤ì „ 9ì‹œ(UTC)
  schedule:
    - cron: '0 9 * * 1,4'  # ì›”ìš”ì¼(1), ëª©ìš”ì¼(4) ì˜¤ì „ 9ì‹œ UTC
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Ping Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_ANON_KEY;
          
          if (!supabaseUrl || !supabaseKey) {
            console.error('âŒ SUPABASE_URL ë˜ëŠ” SUPABASE_ANON_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            console.error('GitHub Secretsì— ë‹¤ìŒ ê°’ë“¤ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”:');
            console.error('  - SUPABASE_URL');
            console.error('  - SUPABASE_ANON_KEY');
            process.exit(1);
          }
          
          const supabase = createClient(supabaseUrl, supabaseKey);
          
          console.log('ğŸ”„ Supabaseì— í•‘ì„ ë³´ë‚´ëŠ” ì¤‘...');
          
          // ê°„ë‹¨í•œ SELECT ì¿¼ë¦¬ ì‹¤í–‰ (content_edits í…Œì´ë¸” ì¡°íšŒ)
          // ì´ í…Œì´ë¸”ì€ ê³µê°œ ì¡°íšŒê°€ ê°€ëŠ¥í•˜ë©° í•­ìƒ ì¡´ì¬í•©ë‹ˆë‹¤
          supabase
            .from('content_edits')
            .select('id')
            .limit(1)
            .then(({ data, error }) => {
              if (error) {
                console.error('âŒ Supabase í•‘ ì‹¤íŒ¨:', error.message);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', JSON.stringify(error, null, 2));
                process.exit(1);
              }
              console.log('âœ… Supabase í•‘ ì„±ê³µ! í”„ë¡œì íŠ¸ê°€ í™œì„± ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤.');
              console.log('ğŸ“Š ì‘ë‹µ ë°ì´í„°:', data ? 'ë°ì´í„° ì¡°íšŒ ì„±ê³µ' : 'ë°ì´í„° ì—†ìŒ (ì •ìƒ)');
            })
            .catch((err) => {
              console.error('âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:', err.message);
              console.error('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', err.stack);
              process.exit(1);
            });
          "

      - name: Success message
        if: success()
        run: |
          echo "âœ… Supabase í”„ë¡œì íŠ¸ê°€ í™œì„± ìƒíƒœë¡œ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ë‹¤ìŒ ì‹¤í–‰: ë§¤ì£¼ ì›”ìš”ì¼, ëª©ìš”ì¼ ì˜¤ì „ 9ì‹œ(UTC)"

